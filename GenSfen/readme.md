# GenSfen

教師局面の生成を行うためのスクリプトです。

USIプロトコル対応のエンジンを用いて教師データの生成を行います。

ここで生成した教師データは、pack形式となります。このpack形式は、hcpe形式に変換することができ、dlshogiの学習スクリプトである`train.py`で用いることができます。


# pack形式データフォーマット

ここで紹介するpack形式は、ファイルサイズを限りなく小さくする目的でやねうらおが考案しました。

対局棋譜がほぼそのままバイナリーデータとなります。

以下では、

- `:=`は定義。左側の定義が右側に来る。
- `*`は0回以上の繰り返し
- `+`は1回以上の繰り返し
- `:` この右側に説明を書くための記号

を意味するものとします。

また、エンディアンはLE(Little Endian)であるものとします。

💡 比較的BNF記法に近い。BNF記法を参照すること。

pack形式のデータ := 対局棋譜*

対局棋譜 := 開始局面 (指し手 評価値)* 終端記号

開始局面 :=
-    0(1byte) Aperyのhcp形式の局面(32byte) : cshogiで直接扱える
-    1(1byte) : startpos(平手の初期局面)
-    2～(1byte) : 予約。ここは駒落ちなどの初期局面を割り当てるかも。

📝 0(1byte)であったときは、平手の開始局面。1(1byte)であったときは、そのあとにPackedSfen形式(32byteに符号化された局面データ。これはやねうら王で用いられるもの)が来るという意味。

指し手 := AperyのMove16(2byte) : cshogiで直接扱える

評価値 := 符号付き16bit整数(2byte)

終端記号 :=
- 0x0000(2byte) 終局理由(1byte) : 引き分け。
- 0x0101(2byte) 終局理由(1byte) : BLACK(先手側)の勝ち。
- 0x0202(2byte) 終局理由(1byte) : WHITE(後手側)の勝ち。

💡 指し手(Move16)としてみたときに0x0000(2byte)は将棋盤の11の駒を11に移動させる指し手なのでこのような指し手は存在しない。0x0101, 0x0202も同様。なので、指し手と区別がつく。

📝 終端記号は、hcpeのgame resultに準拠させてある。

終局理由 :=

(直前が0のとき = 引き分けの時)
- 1(1byte) interrupt : (システムによる)対局の中断による引き分け。
- 2(1byte) draw : 千日手引き分け。
- 3(1byte) max moves : 最大手数による引き分け。
- 4(1byte) draw csa24 : 入玉宣言による引き分け。24点法。(24点以上30点以下)
- 255(1byte) : その他の引き分け。

(直前が1のとき = 手番側が勝ちの時)
- 1(1byte) win csa24 : 入玉宣言勝ち。手番側の勝ち。24点法。(31点以上)
- 2(1byte) win csa27 : 入玉宣言勝ち。手番側の勝ち。27点法。(先手28点、後手27点以上)
- 3(1byte) win try_rule : トライルールによる宣言勝ち。手番側の勝ち。
- 255(1byte) : その他の手番側の勝ち。

(直前が2のとき = 非手番側が勝ちの時)
- 1(1byte) interrupt : (プレイヤーによる中断)対局の中断による負け。非手番側の勝ち。
- 2(1byte) time up : 時間切れ負け。非手番側の勝ち。
- 3(1byte) resign : 投了。非手番側の勝ち。
- 4(1byte) illegal move : 反則手。非手番側の勝ち。
- 5(1byte) repetition check : 連続王手の千日手による反則負け。非手番側の勝ち。
- 255(1byte) : その他の非手番側の勝ち。

